name: Sync API Docs to Apifox
# è§¦å‘æ¡ä»¶ï¼šå½“ master æˆ– main åˆ†æ”¯æœ‰ä»£ç  push æ—¶è§¦å‘
on:
  push:
    branches:
      - main

jobs:
  update-apifox-docs:
    runs-on: ubuntu-latest # ä½¿ç”¨ Ubuntu è™šæ‹Ÿç³»ç»Ÿ

    # ã€çŸ¥è¯†ç‚¹ 1ã€‘æœåŠ¡å®¹å™¨
    # å› ä¸º SpringBoot å¯åŠ¨éœ€è¦è¿æ•°æ®åº“ï¼Œä½† GitHub çš„è™šæ‹Ÿæœºé‡Œæ²¡æœ‰ MySQLã€‚

    # æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä¸´æ—¶èµ·ä¸€ä¸ª MySQL å’Œ Redis ç»™å®ƒè¿ã€‚
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: campus_market
          MYSQL_USER: AccyCx
          MYSQL_PASSWORD: ycy0050307
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379

    steps:
      # 1. ä¸‹è½½ä½ çš„ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3. å¯åŠ¨ Spring Boot å¹¶ç”Ÿæˆ OpenAPI JSON
      # è¿™é‡Œç”¨äº†ä¸€ä¸ªæŠ€å·§ï¼šè®©ç¨‹åºåœ¨åå°è¿è¡Œï¼Œç„¶åç”¨ curl æŠ“å– JSON
      - name: Generate OpenAPI JSON
        working-directory: ./backend # è¿›å…¥åç«¯ç›®å½•
        run: |
          # 1. ã€æ ¸å¿ƒä¿®æ”¹ã€‘åŠ ä¸Š cleanï¼Œå¼ºåˆ¶æ¸…é™¤æ—§æ–‡ä»¶ï¼Œç¡®ä¿ç¼–è¯‘çš„æ˜¯æœ€æ–°ä»£ç 
          mvn clean spring-boot:run -Dspring-boot.run.profiles=dev -Dmaven.test.skip=true &
             
          echo "Waiting for service to start..."
          for i in {1..60}; do  # ç¨å¾®å»¶é•¿ç­‰å¾…æ—¶é—´åˆ° 60æ¬¡
            if curl -s http://localhost:8080/v3/api-docs > openapi.json; then
              if [ -s openapi.json ]; then
                echo "âœ… OpenAPI JSON generated successfully!"
          
                # 2. ã€æ ¸å¿ƒä¿®æ”¹ã€‘æŠŠç”Ÿæˆçš„ JSON æ‰“å°å‡ºæ¥ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å®ƒè‚šå­é‡Œåˆ°åº•æ˜¯æ–°ä»£ç è¿˜æ˜¯æ—§ä»£ç 
                echo "====== DEBUG START: openapi.json content ======"
                cat openapi.json
                echo "====== DEBUG END ======"
               
                exit 0
              fi
            fi
            echo "Sleeping 5 seconds..."
            sleep 5
          done
          echo "âŒ Failed to generate OpenAPI JSON"
          exit 1
      # 4. æ¨é€åˆ° Apifox
      - name: Upload to Apifox
        working-directory: ./backend
        run: |
          echo "ğŸš€ Uploading to Apifox via curl..."
          
          # ã€å…³é”®ä¿®æ”¹ã€‘åœ¨æ–‡ä»¶ååé¢åŠ ä¸Š ;type=application/json
          # è¿™ä¼šå‘Šè¯‰ Apifox æœåŠ¡å™¨ï¼šæˆ‘ä¼ çš„æ˜¯ JSONï¼Œè¯·è§£æå®ƒï¼ä¸è¦å¿½ç•¥å®ƒï¼
          curl --location --request POST "https://api.apifox.cn/v1/projects/${{ secrets.APIFOX_PROJECT_ID }}/import-openapi" \
          --header "Authorization: Bearer ${{ secrets.APIFOX_TOKEN }}" \
          --header " X-Apifox-Version: 2024-03-28" \
          --form "file=@openapi.json;type=application/json" \
          --form "options={\"overwrite\":true}" \
          --fail 
          
          echo "ğŸ‰ Upload finished successfully!"