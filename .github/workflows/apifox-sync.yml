name: Sync API Docs to Apifox

on:
  push:
    branches:
      - main

jobs:
  update-apifox-docs:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: campus_market
          MYSQL_USER: AccyCx
          MYSQL_PASSWORD: ycy0050307
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Generate OpenAPI JSON
        working-directory: ./backend
        run: |
          mvn spring-boot:run -Dspring-boot.run.profiles=dev -Dmaven.test.skip=true &
          echo "Waiting for service to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/v3/api-docs > openapi.json; then
              if [ -s openapi.json ]; then
                echo "‚úÖ OpenAPI JSON generated successfully!"
                exit 0
              fi
            fi
            echo "Sleeping 5 seconds..."
            sleep 5
          done
          echo "‚ùå Failed to generate OpenAPI JSON"
          exit 1

      - name: Upload to Apifox
        working-directory: ./backend
        run: |
          curl --location --request POST "https://api.apifox.cn/api/v1/projects/${{ secrets.APIFOX_PROJECT_ID }}/import-openapi?token=${{ secrets.APIFOX_TOKEN }}" \
          --header 'Content-Type: multipart/form-data' \
          --form 'file=@"openapi.json"' \
          --form 'options={"overwrite":true}'
          echo "üéâ Docs synced to Apifox!"