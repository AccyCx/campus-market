name: Sync API Docs to Apifox
# è§¦å‘æ¡ä»¶ï¼šå½“ master æˆ– main åˆ†æ”¯æœ‰ä»£ç  push æ—¶è§¦å‘
on:
  push:
    branches:
      - main

jobs:
  update-apifox-docs:
    runs-on: ubuntu-latest # ä½¿ç”¨ Ubuntu è™šæ‹Ÿç³»ç»Ÿ

    # ã€çŸ¥è¯†ç‚¹ 1ã€‘æœåŠ¡å®¹å™¨
    # å› ä¸º SpringBoot å¯åŠ¨éœ€è¦è¿æ•°æ®åº“ï¼Œä½† GitHub çš„è™šæ‹Ÿæœºé‡Œæ²¡æœ‰ MySQLã€‚

    # æ‰€ä»¥æˆ‘ä»¬åœ¨è¿™é‡Œä¸´æ—¶èµ·ä¸€ä¸ª MySQL å’Œ Redis ç»™å®ƒè¿ã€‚
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
          MYSQL_DATABASE: campus_market
          MYSQL_USER: AccyCx
          MYSQL_PASSWORD: ycy0050307
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

      redis:
        image: redis:7.0
        ports:
          - 6379:6379

    steps:
      - # 1. ä¸‹è½½ä½ çš„ä»£ç 
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. è®¾ç½® JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      # 3. å¯åŠ¨ Spring Boot å¹¶ç”Ÿæˆ OpenAPI JSON
      # è¿™é‡Œç”¨äº†ä¸€ä¸ªæŠ€å·§ï¼šè®©ç¨‹åºåœ¨åå°è¿è¡Œï¼Œç„¶åç”¨ curl æŠ“å– JSON
      - name: Generate OpenAPI JSON
        working-directory: ./backend # è¿›å…¥åç«¯ç›®å½•
        run: |
          # åå°å¯åŠ¨åº”ç”¨ï¼Œå¿½ç•¥æµ‹è¯• ( & è¡¨ç¤ºåå°è¿è¡Œ )
          mvn spring-boot:run -Dspring-boot.run.profiles=dev -Dmaven.test.skip=true &
          
          # å¾ªç¯ç­‰å¾…æœåŠ¡å¯åŠ¨ï¼ˆæ¯ 5 ç§’è¯•ä¸€æ¬¡ï¼Œæœ€å¤šè¯• 30 æ¬¡ï¼‰
          echo "Waiting for service to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/v3/api-docs > openapi.json; then
              if [ -s openapi.json ]; then
                echo "âœ… OpenAPI JSON generated successfully!"
                exit 0
              fi
            fi
            echo "Sleeping 5 seconds..."
            sleep 5
          done
          echo "âŒ Failed to generate OpenAPI JSON"
          exit 1

      # 4. æ¨é€åˆ° Apifox
      - name: Upload to Apifox
        working-directory: ./backend
        run: |
          # è°ƒç”¨ Apifox çš„å®˜æ–¹ API ä¸Šä¼ æ–‡ä»¶
          curl --location --request POST "https://api.apifox.cn/api/v1/projects/${{ secrets.APIFOX_PROJECT_ID }}/import-openapi?token=${{ secrets.APIFOX_TOKEN }}" \
          --header 'Content-Type: multipart/form-data' \
          --form 'file=@"openapi.json"' \
          --form 'options={"overwrite":true}' # è¦†ç›–æ—§æ–‡æ¡£
          echo "ğŸ‰ Docs synced to Apifox!"